Compspec, a compiler for XXX
=====================================================================

[User Manual](XXXX)
-------------


Installation via Opam
---------------------
TODO

Compilation from the sources
----------------------------

You can get the sources using `git` as follows:
```bash
git clone git@gitlab.lip6.fr:lprosperi/compiler.git
```

Dependencies are described in `compspec.opam`. For building the source
code documentation, one needs
[odoc](https://github.com/ocaml/odoc). For building the User Manual,
see `docs/README.md`.

Using Opam, a suitable OCaml environment can be setup as follows (automated script ``requirements.sh``):
```bash
opam switch 4.12.0
opam install yaml ounit2 process rresult pprint ppx_deriving menhir bos fileutils
```

To compile Compspec, just run the command `make` in the source directory.
This produces the `_build/install/default/bin/compspec` binary.
Use the `--help` option for more information. Other make targets are:

```bash
make                        # Build compspec 
#make doc                    # Build the user documentation (avalaible on readthedocs)
make odoc                   # Build the developer documentation
make install                # Install compspec 
#make vscode                 # Install vscode extension
make tests
```

**Note:** you can run `compspec` without installing it with `dune exec -- compspec`.

**Note:** the starting file of the source code html documentation is
`_build/default/_doc/_html/compspec/index.html`.

The following commands can be used to clean up the repository:
```bash
make clean     # Removes files generated by OCaml.
make distclean # Same as clean, but also removes library checking files.
```
### Usage (without installing) 

* message-passing encoding
```bash
make run -- compile --places examples/0-ping-pong/places.yml --targets examples/0-ping-pong/targets.yml --filename examples/0-ping-pong/pingpong.spec --impl examples/0-ping-pong/pingpong.impl --provenance 0
```
* counter
```bash
make run -- compile --places examples/1-counter/places.yml --targets examples/1-counter/targets.yml --filename examples/1-counter/counter.spec --impl examples/1-counter/counter.impl --provenance 0
```
* kvs
```bash
make run -- compile --debug --places examples/kvs/places.yml --targets examples/kvs/targets.yml --filename examples/kvs/kvs.spec --impl examples/kvs/kvs.impl --provenance 0
```

```
make run -- info
```

Compile the akka source code generated by the Lg4DC compiler
```
    cd compiler-build/akka && gradle jarMain
    java -jar build/libs/main.jar
```
```
docker build .
```

Start a compiler with the compiled jar
```
docker-compose up -d
```

# Docker and Docker-Compose

A little tweak/hack is currently needed for the console application to work from outside a docker context.
Add the following to /etc/hosts: `127.0.0.1 host.docker.internal kvs-server-seed`


## build
```docker-compose build```

## run
start all services
```docker-compose up -d```

start a shell in a container that is on the same network as the kvs services 
```docker run -it --rm --network kvs_default kvs-server```

## Vizualisation tools

* Static logic topology
after compilation (that generate the .dot file) run ``make sltopology``

## Akka target

### Requirements
```
------------------------------------------------------------
Gradle 7.1.1
------------------------------------------------------------

Build time:   2021-07-02 12:16:43 UTC
Revision:     774525a055494e0ece39f522ac7ad17498ce032c

Kotlin:       1.4.31
Groovy:       3.0.7
Ant:          Apache Ant(TM) version 1.10.9 compiled on September 27 2020
JVM:          11.0.12 (Debian 11.0.12+7-post-Debian-2)
OS:           Linux 5.10.0-6-amd64 amd64
```